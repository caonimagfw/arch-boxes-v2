name: Build CloudCone Arch Raw

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Build version (e.g. 6.18.7 or 20260211.1)"
        required: true
        default: "6.18.7"
        type: string
      overwrite_release:
        description: "If release tag exists, delete and recreate it"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: cloudcone-raw-${{ github.event.inputs.version }}
  cancel-in-progress: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    env:
      IMAGE_FILTER: cloud-image.sh
      MAX_RELEASE_ASSET_BYTES: "2200000000"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Preflight checks (host + privileged container)
        run: |
          set -euo pipefail
          docker --version
          sudo docker info >/dev/null
          sudo docker run --rm --privileged \
            -v /dev:/dev \
            --entrypoint bash \
            archlinux:latest \
            -lc '
              set -euo pipefail
              pacman -Sy --noconfirm --needed e2fsprogs util-linux >/dev/null
              command -v losetup mount mkfs.ext4
            '

      - name: Validate or cleanup release tag state
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          TAG: v${{ github.event.inputs.version }}
          OVERWRITE: ${{ github.event.inputs.overwrite_release }}
        run: |
          set -euo pipefail
          if gh release view "${TAG}" --repo "${REPO}" >/dev/null 2>&1; then
            if [ "${OVERWRITE}" != "true" ]; then
              echo "Release tag ${TAG} already exists."
              echo "Use a new version, or rerun with overwrite_release=true."
              exit 1
            fi
            gh release delete "${TAG}" --repo "${REPO}" --cleanup-tag --yes
          fi

      - name: Format disk image with Debian 11 e2fsprogs (GRUB compatibility)
        run: |
          set -euo pipefail
          # Use Debian 11's e2fsprogs (1.46.2) to create the ext4 filesystem.
          # This ensures binary-level compatibility with CloudCone's host GRUB (2.02-81.el8),
          # which cannot read ext4 features produced by newer e2fsprogs versions.
          sudo docker run --rm --privileged \
            -v /dev:/dev \
            -v "${PWD}:/workspace" \
            -w /workspace \
            debian:11 \
            bash -c '
              set -euo pipefail
              apt-get update -qq && apt-get install -y -qq e2fsprogs fdisk >/dev/null 2>&1

              echo "=== Debian 11 e2fsprogs version ==="
              mkfs.ext4 -V 2>&1 || true

              IMAGE=/workspace/preformatted.img
              truncate -s 5G "${IMAGE}"

              # Create standard MBR partition table (start=2048, matching CloudCone official images)
              echo "start=2048, type=83, bootable" | sfdisk "${IMAGE}"

              # Setup loop device for partition 1 (offset 1MiB = 1048576 bytes)
              LOOPDEV=$(losetup --offset 1048576 --find --show "${IMAGE}")

              # Format ext4 using our custom mke2fs.conf (disables 64bit/metadata_csum)
              MKE2FS_CONFIG=/workspace/debian11-mke2fs.conf mkfs.ext4 -F "${LOOPDEV}"

              echo "=== Filesystem features ==="
              tune2fs -l "${LOOPDEV}" | grep -E "features|Inode size|Block size"

              losetup -d "${LOOPDEV}"
              echo "Pre-formatted image created successfully."
            '

      - name: Build cloud-image raw in privileged Arch container
        run: |
          set -euo pipefail
          sudo docker run --rm --privileged \
            -v /dev:/dev \
            -e "IMAGE_FILTER=${IMAGE_FILTER}" \
            -e "PREFORMATTED_IMAGE=/workspace/preformatted.img" \
            -v "${PWD}:/workspace" \
            -w /workspace \
            archlinux:latest \
            bash -lc '
              set -euo pipefail
              pacman -Syu --noconfirm \
                arch-install-scripts \
                e2fsprogs \
                util-linux \
                zstd
              chmod +x ./build.sh ./images/*.sh
              ./build.sh "${{ github.event.inputs.version }}"
            '

      - name: Fix output ownership
        run: |
          set -euo pipefail
          sudo chown -R "$(id -u):$(id -g)" output

      - name: Verify artifacts and enforce release size guard
        run: |
          set -euo pipefail
          ls -lah output
          raw_zst_file="$(ls output/*cloudimg*.raw.zst)"
          tar_zst_file="$(ls output/*cloudimg*.tar.zst)"

          sha256sum "${raw_zst_file}" > "${raw_zst_file}.SHA256"
          sha256sum "${tar_zst_file}" > "${tar_zst_file}.SHA256"

          for artifact in "${raw_zst_file}" "${tar_zst_file}"; do
            artifact_size="$(stat -c '%s' "${artifact}")"
            echo "Artifact: ${artifact}"
            echo "Size bytes: ${artifact_size}"
            echo "Size human: $(numfmt --to=iec "${artifact_size}")"
            if [ "${artifact_size}" -gt "${MAX_RELEASE_ASSET_BYTES}" ]; then
              echo "Artifact ${artifact} is too large for guarded release threshold (${MAX_RELEASE_ASSET_BYTES} bytes)."
              echo "Reduce image size or raise MAX_RELEASE_ASSET_BYTES if your repo policy allows."
              exit 1
            fi
          done

      - name: Print SHA256 for release audit
        run: |
          set -euo pipefail
          sha256sum output/*cloudimg*.raw.zst output/*cloudimg*.tar.zst

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Arch Linux CloudCone Raw/Tar Zst v${{ github.event.inputs.version }}
          generate_release_notes: true
          files: |
            output/*cloudimg*.raw.zst
            output/*cloudimg*.raw.zst.SHA256
            output/*cloudimg*.tar.zst
            output/*cloudimg*.tar.zst.SHA256
          fail_on_unmatched_files: true
