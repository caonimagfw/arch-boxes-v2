name: Build CloudCone Arch Raw

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Build version (e.g. 6.18.7 or 20260211.1)"
        required: true
        default: "6.18.7"
        type: string
      overwrite_release:
        description: "If release tag exists, delete and recreate it"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: cloudcone-raw-${{ github.event.inputs.version }}
  cancel-in-progress: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    env:
      IMAGE_FILTER: cloud-image.sh
      MAX_RELEASE_ASSET_BYTES: "2200000000"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Preflight checks (host + privileged container)
        run: |
          set -euo pipefail
          docker --version
          sudo docker info >/dev/null
          sudo docker run --rm --privileged \
            -v /dev:/dev \
            --entrypoint bash \
            archlinux:latest \
            -lc '
              set -euo pipefail
              pacman -Sy --noconfirm --needed e2fsprogs util-linux >/dev/null
              command -v losetup mount mkfs.ext4
            '

      - name: Validate or cleanup release tag state
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          TAG: v${{ github.event.inputs.version }}
          OVERWRITE: ${{ github.event.inputs.overwrite_release }}
        run: |
          set -euo pipefail
          if gh release view "${TAG}" --repo "${REPO}" >/dev/null 2>&1; then
            if [ "${OVERWRITE}" != "true" ]; then
              echo "Release tag ${TAG} already exists."
              echo "Use a new version, or rerun with overwrite_release=true."
              exit 1
            fi
            gh release delete "${TAG}" --repo "${REPO}" --cleanup-tag --yes
          fi

      - name: Build cloud-image raw in privileged Arch container
        run: |
          set -euo pipefail
          sudo docker run --rm --privileged \
            -v /dev:/dev \
            -e "IMAGE_FILTER=${IMAGE_FILTER}" \
            -v "${PWD}:/workspace" \
            -w /workspace \
            archlinux:latest \
            bash -lc '
              set -euo pipefail
              pacman -Syu --noconfirm \
                arch-install-scripts \
                e2fsprogs \
                util-linux \
                zstd \
                base-devel

              # Build e2fsprogs 1.46.2 (matches Debian 11 / CloudCone GRUB 2.02).
              # The system e2fsprogs (latest Arch) is kept for pacstrap/tune2fs/e2fsck;
              # only mkfs.ext4 is overridden with the old version to produce a
              # GRUB 2.02-compatible on-disk format.
              E2FS_VER=1.46.2
              curl -sL "https://kernel.org/pub/linux/kernel/people/tytso/e2fsprogs/v${E2FS_VER}/e2fsprogs-${E2FS_VER}.tar.gz" | tar xz
              cd "e2fsprogs-${E2FS_VER}"
              ./configure --prefix=/opt/e2fs-compat --disable-nls --disable-defrag >/dev/null
              make -j"$(nproc)" >/dev/null
              make install >/dev/null
              cd ..
              echo "=== e2fsprogs compat version ==="
              /opt/e2fs-compat/sbin/mkfs.ext4 -V 2>&1 || true

              chmod +x ./build.sh ./images/*.sh
              ./build.sh "${{ github.event.inputs.version }}"
            '

      - name: Fix output ownership
        run: |
          set -euo pipefail
          sudo chown -R "$(id -u):$(id -g)" output

      - name: Verify artifacts and enforce release size guard
        run: |
          set -euo pipefail
          ls -lah output
          raw_zst_file="$(ls output/*cloudimg*.raw.zst)"
          tar_zst_file="$(ls output/*cloudimg*.tar.zst)"

          sha256sum "${raw_zst_file}" > "${raw_zst_file}.SHA256"
          sha256sum "${tar_zst_file}" > "${tar_zst_file}.SHA256"

          for artifact in "${raw_zst_file}" "${tar_zst_file}"; do
            artifact_size="$(stat -c '%s' "${artifact}")"
            echo "Artifact: ${artifact}"
            echo "Size bytes: ${artifact_size}"
            echo "Size human: $(numfmt --to=iec "${artifact_size}")"
            if [ "${artifact_size}" -gt "${MAX_RELEASE_ASSET_BYTES}" ]; then
              echo "Artifact ${artifact} is too large for guarded release threshold (${MAX_RELEASE_ASSET_BYTES} bytes)."
              echo "Reduce image size or raise MAX_RELEASE_ASSET_BYTES if your repo policy allows."
              exit 1
            fi
          done

      - name: Print SHA256 for release audit
        run: |
          set -euo pipefail
          sha256sum output/*cloudimg*.raw.zst output/*cloudimg*.tar.zst

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Arch Linux CloudCone Raw/Tar Zst v${{ github.event.inputs.version }}
          generate_release_notes: true
          files: |
            output/*cloudimg*.raw.zst
            output/*cloudimg*.raw.zst.SHA256
            output/*cloudimg*.tar.zst
            output/*cloudimg*.tar.zst.SHA256
          fail_on_unmatched_files: true
